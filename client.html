<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>es6</title>
  </head>
  <body>
    <canvas></canvas><br>
    <h1 id="p1">0</h1>
    <h1 id="p2">0</h1>
    <button id="reset">Reset</button>
    <script src="/socket.io/socket.io.js"></script>
    <script></script>
    <script>
      var socket = io();
      let canvas = document.querySelector("canvas");
      let width = (canvas.width = 615);
      let height = (canvas.height = 800);
      canvas.style.border = "solid 1px red";

      let ctx = canvas.getContext("2d");

      let gamestate;

      class Bola{
      
      constructor(x, y, ballSpeed, tamanho, cor) {
        this.x = x;
        this.y = y;
        this.velox = 5;
        this.veloy = 5;
        this.cor = cor;
        this.tamanho = tamanho;
        this.datasync = null;
      }

      setData(data) {
        this.datasync = data;
      };

      desenhar() {
        ctx.beginPath();
        ctx.fillStyle = this.cor;
        ctx.arc(this.x, this.y, this.tamanho, 0, 2 * Math.PI);
        ctx.fill();
      };

      update() {
        if (gamestate) {
          this.x = gamestate.ball.x;
          this.y = gamestate.ball.y;
          this.velox = gamestate.velox;
          this.veloy = gamestate.veloy;
        }
      };
    }

      class Paddle {
        constructor(y, color) {
            this.color = color;
            this.velocity = 8;
            this.pos = width/2;
            this.y = y;
        }

        update() {
          
        }

        draw() {
          ctx.beginPath();
          ctx.fillStyle = this.color;
          ctx.rect(this.pos, this.y, 80, 15);
          ctx.fill();
        }
      }

      socket.on('score', (p1, p2) => {
        document.querySelector("#p1").innerHTML = p1;
        document.querySelector("#p2").innerHTML = p2;
      })

      socket.on('player1', (id) => {
        if(id === socket.id){
          window.addEventListener('keydown', (e) => {
            console.log('a');
            if (e.key === "ArrowLeft") {
              player1.pos -= player1.velocity;
              socket.emit("player1Mov", player1.pos);
            }else if (e.key === "ArrowRight") {
              player1.pos += player1.velocity;
              socket.emit("player1Mov", player1.pos);
            }
          })
        }
      })

      socket.on('player2', (id) => {
        socket.emit('sla', "AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA")
        if(id === socket.id){
          window.addEventListener('keydown', (e) => {
            console.log('b');
            if (e.key === "ArrowLeft") {
              player2.pos -= player2.velocity;
              socket.emit("player2Mov", player2.pos);
            }else if (e.key === "ArrowRight") {
              player2.pos += player2.velocity;
              socket.emit("player2Mov", player2.pos);
            }
          })
        }
      })

      let bola = new Bola(80, 80, 5, 10, "blue", 10);
      let player1 = new Paddle(canvas.height - 15, "blue");
      let player2 = new Paddle(0, "red");

      function loop() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        socket.on('player1Mov', (pos) => {
          player1.pos = pos;
        })

        socket.on('player2Mov', (pos) => {
          player2.pos = pos;
        })

        player1.draw();
        player1.update();

        player2.draw();
        player2.update();

        bola.desenhar();
        bola.update();
      }

      //update
      interval = setInterval(() => {
        loop();
      }, (1 / 100) * 1000);

      var host = window.location.href;
      console.log(host);
      var socket = io.connect(host);

      socket.on("game-started", (data) => {
        console.log(data);
      });

      socket.on("game-sync", (data) => {
        //console.log(data);
        gamestate = data;
      });

      document.querySelector("#reset").addEventListener("click", () => {
        socket.emit("reset");
      });
    </script>
  </body>
</html>
